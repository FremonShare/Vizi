<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Futurgo LTD</title>
<!--  http://www.google.com/fonts#UsePlace:use/Collection:PT+Sans  -->
	<link rel="stylesheet" href="../libs/jquery-ui-1.10.3.custom/css/ui-lightness/jquery-ui-1.10.3.custom.css" />
	<link rel="stylesheet" media="screen" type="text/css" href="../libs/colorpicker/css/colorpicker.css" />
	<link href='./css/fonts.css' rel='stylesheet' type='text/css'>
	<link href="./css/futurgo.css" rel="stylesheet" type='text/css'/> 
</head>
<body>
	<div id="top_frame"></div>
	<div id="menubar">
	    <div id="menuORDER" class="menuItem" onclick="onMenuCommand(this.id);">ORDER</div>
	    <div id="menuTEST_DRIVE" class="menuItem" onclick="onMenuCommand(this.id);">TEST DRIVE</div>
	    <div id="menuFEATURES" class="menuItem" onclick="onMenuCommand(this.id);">FEATURES</div>
	    <div id="menuSPECS" class="menuItem" onclick="onMenuCommand(this.id);">SPECS</div>
	    <div id="menuCHARGING" class="menuItem" onclick="onMenuCommand(this.id);">CHARGING</div>
	    <div id="menuGALLERY" class="menuItem" onclick="onMenuCommand(this.id);">GALLERY</div>
	    <div id="menuVIDEO" class="menuItem" onclick="onMenuCommand(this.id);">VIDEO</div>
	    <div id="menuFAQ" class="menuItem" onclick="onMenuCommand(this.id);">QUESTIONS?</div>
	    <span></span>
  	</div>
	<div id="bot_frame"></div>
	<div id="left_banner_bg"></div>
	<div id="futurgo_logo"></div>
	<div id="ltd_model"></div>
	<div id="left_banner_title">Lifestyle Transportation Device</div>
	<div id="left_banner_copy">
	Get where you need to go in style, in <i>Futurgo&trade;</i>'s revolutionary
	new personal transportation system!<p></p>
	The LTD&reg; features sleek styling, ergonomic design and a 
	patent-pending drive train that really moves.<p></p>
	Experience the future in personal transportation... TODAY!<p></p>
	</div>
	<div id="tabbar_right">
		<div id="tab01"><div class="tabLink" onclick=""></div></div>
		<div id="tab02"><div class="tabLink" onclick=""></div></div>
		<div id="tab03"><div class="tabLink" onclick="toggleInterior();"></div></div>
		<div id="tab04"><div class="tabLink" onclick="toggleWheelAnimations();"></div></div>
		<div id="tab05"><div class="tabLink" onclick=""></div></div>
	</div>
	<div id="bottom_legend">The World's First All-Electric Personal Vehicle. 
	Zero Emissions. 4.9 Sec 0-60 Max Acceleration.
	</div>
	<div id="vizi_powered"></div>
	<div id="container"></div>
	<div id="loadStatus" style="display:none">
	Loading scene...
	</div>
	<div id="overlay" style="display:none">
		<div id="overlayContents">overlay contents</div>
		<div id="overlayLogo"></div>
	</div>

    <script src="../libs/jquery-1.9.1/jquery-1.9.1.js"></script>
    <script src="../libs/jquery-ui-1.10.3.custom/js/jquery-ui-1.10.3.custom.js"></script>
	<script src="../libs/colorpicker/js/colorpicker.js"></script>
	<script src="../build/vizi.js"></script>
	<script src="sceneViewer.js"></script>
	<script>

   	var viewer = null;
   	var container = null;
   	var overlay = null;
   	var overlayContents = null;
   	var part_materials = [];
   	
	$(document).ready(function() {

		initControls();
		overlay = document.getElementById("overlay");
		overlayContents = document.getElementById("overlayContents");
		container = document.getElementById("container");		
		viewer = new SceneViewer({ container : container, showGrid : true, headlight : false });
		openFile("./models/vizi_mobile_tc01/vizi_mobile_tc01.json");
		viewer.run();
	}
	);

	function initControls() {
		$('#tab02').ColorPicker({
			color: '#ffffff',
			onBeforeShow: function () {
				var hex = '#ffffff';
				if (part_materials.length) {
					var material = part_materials[0];
					if (material instanceof THREE.MeshFaceMaterial) {
						hex = '#' + material.materials[0].color.getHexString();
					}
					else {
						hex = '#' + material.color.getHexString();
					}
				}
				$(this).ColorPickerSetColor(hex);
			},
			onShow: function (colpkr) {
				$(colpkr).fadeIn(250);
				return false;
			},
			onHide: function (colpkr) {
				$(colpkr).fadeOut(250);
				return false;
			},
			onChange: function (hsb, hex, rgb) {
				setBodyColor(rgb.r, rgb.g, rgb.b);
			},
			onSubmit: function(hsb, hex, rgb, el) {
				$(el).val(hex);
				setBodyColor(rgb.r, rgb.g, rgb.b);
				$(el).ColorPickerHide();
			},
		});
	}
	
	function openFile(url) {
		var loader = new Vizi.Loader;

		loader.addEventListener("loaded", function(data) { onLoadComplete(data, loadStartTime); }); 
		loader.addEventListener("progress", function(progress) { onLoadProgress(progress); }); 

		var loadStartTime = Date.now();
		loader.loadScene(url);
		
		var loadStatus = document.getElementById("loadStatus");
		loadStatus.style.display = 'block';		
	}
	
	function onLoadComplete(data, loadStartTime)
	{
		// Hide the loader bar
		var loadStatus = document.getElementById("loadStatus");
		loadStatus.style.display = 'none';		

		var scene = data.scene;
		viewer.replaceScene(data);

		var loadTime = (Date.now() - loadStartTime) / 1000;
		Vizi.System.log("Loaded " + loadTime.toFixed(2) + " seconds.");

		useCamera("setup");

		scene.map(/windows_front|windows_rear/, function(o) {
			var fader = new Vizi.FadeBehavior({duration:2, opacity:.8});
			o.addComponent(fader);
			setTimeout(function() {
				fader.start();
			}, 2000);

			var picker = new Vizi.Picker;
			picker.addEventListener("mouseover", onGlassMouseOver);
			picker.addEventListener("mouseout", onGlassMouseOut);
			o.addComponent(picker);
		});

		var frame_parts_exp =
			/rear_view_arm_L|rear_view_arm_R|rear_view_frame_L|rear_view_frame_R/;

		scene.map(frame_parts_exp, function(o) {
			o.map(Vizi.Visual, function(v) {
				part_materials.push(v.material);
			});
		});

		scene.map(/body2|rear_view_arm_L|rear_view_arm_R/, function(o) {
			var picker = new Vizi.Picker;
			picker.addEventListener("mouseover", onBodyMouseOver);
			picker.addEventListener("mouseout", onBodyMouseOut);
			o.addComponent(picker);
		});

		scene.map("wheels", function(o) {

			var picker = new Vizi.Picker;
			picker.addEventListener("mouseover", onWheelsMouseOver);
			picker.addEventListener("mouseout", onWheelsMouseOut);
			o.addComponent(picker);
		});
		
		var main = scene.findNode("vizi_mobile");
		var carousel = new Vizi.RotateBehavior({autoStart:true, duration:20});
		main.addComponent(carousel);
	}

	function onLoadProgress(progress)
	{
		// Update the laoder bar
		var percentProgress = progress.loaded / progress.total * 100;
		var loadStatus = document.getElementById("loadStatus");
		loadStatus.innerHTML = "Loading scene... " + percentProgress.toFixed(0) + " %";
	}

	function onMenuCommand(id) {
		console.log("Menu command: ", id);
	}

	function useCamera(name) {
		var cameraNames = viewer.cameraNames;
		var i, len = cameraNames.length;
		for (i = 0; i < len; i++) {
			if (cameraNames[i] == name) {
				viewer.useCamera(i);
				break;
			}
		}		
	}

	/*
	Animation names
	window_rear_open.matrix_window_rear_open
	window_rear_close.matrix_window_rear_close
	window_front_open.matrix_window_front_open
	window_front_close.matrix_window_front_close
	*/
	
	function playAnimation(name, loop) {
		var animationNames = viewer.keyFrameAnimatorNames;
		var index = animationNames.indexOf(name);
		if (index >= 0)
		{
			viewer.playAnimation(index, loop);
		}
	}

	function stopAnimation(name) {
		var animationNames = viewer.keyFrameAnimatorNames;
		var index = animationNames.indexOf(name);
		if (index >= 0)
		{
			viewer.stopAnimation(index);
		}
	}
	
	function playOpenAnimations() {	
		playAnimation("window_rear_open.matrix_window_rear_open");
		playAnimation("window_front_open.matrix_window_front_open");
		playAnimation("animation_window_front_open");
		playAnimation("animation_window_rear_open");
	}

	function playCloseAnimations() {	
		playAnimation("window_rear_close.matrix_window_rear_close");
		playAnimation("window_front_close.matrix_window_front_close");
		playAnimation("animation_window_front_close");
		playAnimation("animation_window_rear_close");
	}

	var vehicleOpen = false;
	function toggleInterior() {
		vehicleOpen = !vehicleOpen;
		if (vehicleOpen) {
			playOpenAnimations();
			return;
			setTimeout(function() {
				useCamera("interior");
			}, 2000);
		}
		else {
			playCloseAnimations();
			return;
			setTimeout(function() {
				useCamera("setup");
			}, 2000);
		}
	}

	function playWheelAnimations() {
		playAnimation("wheel_L.matrix_wheel_L", true);
		playAnimation("wheel_R.matrix_wheel_R", true);
		playAnimation("wheel_front.matrix_wheel_front", true);
		playAnimation("animation_wheel_front", true);
		playAnimation("animation_wheel_L", true);
		playAnimation("animation_wheel_R", true);
	}

	function stopWheelAnimations() {
		stopAnimation("wheel_L.matrix_wheel_L");
		stopAnimation("wheel_R.matrix_wheel_R");
		stopAnimation("wheel_front.matrix_wheel_front");
		stopAnimation("animation_wheel_front");
		stopAnimation("animation_wheel_L");
		stopAnimation("animation_wheel_R");
	}
	
	var wheelsMoving = false;
	function toggleWheelAnimations() {
		wheelsMoving = !wheelsMoving;
		if (wheelsMoving) {
			playWheelAnimations();
		}
		else {
			stopWheelAnimations();
		}
	}
	
	function setBodyColor(r, g, b) {

		// Convert from hex rgb to float
		r /= 255;
		g /= 255;
		b /= 255;
		
		var i, len = part_materials.length;
		for (i = 0; i < len; i++) {
			var material = part_materials[i];
			if (material instanceof THREE.MeshFaceMaterial) {
				var j, mlen = material.materials.length;
				for (j = 0; j < mlen; j++) {
					material.materials[j].color.setRGB(r, g, b);
				}
			}
			else {
				material.color.setRGB(r, g, b);
			}
		}
			
	}

	var glassHTML = "LightAdjust&trade; Windshield - Automatically Changes to Match Day/Night Conditions";
	var bodyHTML = "Titanium Alloy Frame - Lightweight for Speed, with the Highest Safety Rating";
	var wheelsHTML = "LightSpeed&trade; Drive Train - Ride in High Style at High Speeds";
	function showOverlay(html, e) {
		overlay.style.display = 'block';
		overlayContents.innerHTML=html;
		overlay.style.top = e.pageY + 40 + "px";
	}

	function hideOverlay() {
		overlay.style.display = 'none';
	}

	function onGlassMouseOver(e) {
		console.log("Mouse over glass", e);
		showOverlay(glassHTML, e);
	}

	function onGlassMouseOut(e) {
		console.log("Mouse out glass", e);
		hideOverlay();
	}

	function onBodyMouseOver(e) {
		console.log("Mouse over body", e);
		showOverlay(bodyHTML, e);
	}

	function onBodyMouseOut(e) {
		console.log("Mouse out body", e);
		hideOverlay();
	}	

	function onWheelsMouseOver(e) {
		console.log("Mouse over wheels", e);
		showOverlay(wheelsHTML,e);
	}

	function onWheelsMouseOut(e) {
		console.log("Mouse out wheels", e);
		hideOverlay();
	}

	</script>
	
</body>
</html>